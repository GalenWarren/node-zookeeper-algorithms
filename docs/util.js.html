<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: util.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: util.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import pify from 'pify';
import { Observable } from 'rxjs';

/**
* Creates an observable of delay values for retries given the provided retry options
* @param {Object} options
* @param {number} [options.initialDelay=500] - The initial retry delay
* @param {number} [options.delayFactor=2] - The factor by which to increase each delay
* @param {number} [options.maxDelay=8000] - The max delay value
* @param {number} [options.maxRetries=7] - The max number of retries
* @returns {Observable}
*/
export function observeDelay(options = {}) {
  const { initialDelay = 500, delayFactor = 2, maxDelay = 8000, maxRetries = 7 } = options;
  return Observable.generate(
    [0, initialDelay],
    ([index]) => index &lt; maxRetries,
    ([index, delay]) => [index + 1, Math.min(delay * delayFactor, maxDelay)],
    ([, delay]) => delay
  );
}

/**
* Makes an observable retryable with the provided delays.
* @param {Observable} obs$ - The input observable
* @param {Observable} delay$ - The delays to use
* @param {function} [retryPredicate] - Determines if the retry should occur
* based on the supplied error object. If not supplied, all errors are retried.
* @returns {Observable}
*/
export function makeRetryable(obs$, delay$, retryPredicate = null) {
  // retry on error as long as retryPredicate returns true and we have retries left.
  // tack one extra null onto the delay observable; when we encounter that, we know
  // we're out of retries and so should throw the error
  return obs$.retryWhen(error$ =>
    Observable.zip(error$, delay$.concat(Observable.of(null)))
      .flatMap(([error, delay]) => {
        if ((delay !== null) &amp;&amp; (!retryPredicate || retryPredicate(error))) {
          return Observable.of(null).delay(delay);
        }
        return Observable.throw(error);
      })
    );
}

/**
* Creates an observable of the children of a node. The filter and sort functions
* are passed the node names of the children, without the parent path.
* @param {ZookeeperClient} client - The node-zookeeper-client instance
* @param {Object} options
* @param {string} options.path - The path of the parent node
* @param {function} [options.filter] - The filter function
* @param {function} [options.sort] - The sort function
* @param {function} [options.watcher] - The watcher function
*/
export function observeNodeChildren(options) {
  const { client, path, filter = null, sort = null, watcher = null } = options;

  // construct the observable children
  let children$ = Observable.defer(async () => {
    await pify(client.mkdirp).call(client, path);
    const [children] = await pify(client.getChildren).call(client, path, watcher);
    return children;
  });

  // filter and sort if supplied
  if (filter) {
    children$ = children$.map(filter);
  }
  if (sort) {
    children$ = children$.map(sort);
  }

  // return node names (not full paths!)
  return children$;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#connect">connect</a></li><li><a href="global.html#generateClientId">generateClientId</a></li><li><a href="global.html#getClientNodePrefix">getClientNodePrefix</a></li><li><a href="global.html#makeRetryable">makeRetryable</a></li><li><a href="global.html#observeClientState">observeClientState</a></li><li><a href="global.html#observeDelay">observeDelay</a></li><li><a href="global.html#observeLockState">observeLockState</a></li><li><a href="global.html#observeNodeChildren">observeNodeChildren</a></li><li><a href="global.html#parseClientNode">parseClientNode</a></li><li><a href="global.html#sortBySequence">sortBySequence</a></li><li><a href="global.html#unsubscribe">unsubscribe</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Mar 18 2017 19:55:49 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
