<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: recipes/oneForAll.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: recipes/oneForAll.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Observable } from 'rxjs';
import { observeRemoveNode } from '../util';

/**
* Generates an observable for an all for one action
* @param {Object} options
* @param {Object} options.client - The node-zookeeper-client instance
* @param {Object} options.path - The path on which to get the lock
* @param {string} options.clientNodePrefix - The client node prefix for this action
* @param {function} options.action
* @param {function} options.testActionDone
*/
export function observeOneForAllAction(options) {
  const { client, path, clientNodePrefix, action, testActionDone } = options;
  return this.observeSeekClientNodeState({
    client,
    path,
    clientNodePrefix,
    repeat: async (nodes) => {
      const done = await Promise.resolve(testActionDone());
      if (done) {
        return Observable.of(false);
      }
      return observeRemoveNode(client, nodes[0]).map(() => true);
    }
  }).distinctUntilChanged()
    .flatMap((isLeader) => {
      if (isLeader) {
        action();
      }
    });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#changeEventName">changeEventName</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#generateClientId">generateClientId</a></li><li><a href="global.html#getClientNodePrefix">getClientNodePrefix</a></li><li><a href="global.html#getExclusiveLock">getExclusiveLock</a></li><li><a href="global.html#leaderSelector">leaderSelector</a></li><li><a href="global.html#makeRetryable">makeRetryable</a></li><li><a href="global.html#observeClientState">observeClientState</a></li><li><a href="global.html#observeConnectedState">observeConnectedState</a></li><li><a href="global.html#observeCreateNode">observeCreateNode</a></li><li><a href="global.html#observeDelay">observeDelay</a></li><li><a href="global.html#observeExclusiveLock">observeExclusiveLock</a></li><li><a href="global.html#observeLeaderState">observeLeaderState</a></li><li><a href="global.html#observeNodeChildren">observeNodeChildren</a></li><li><a href="global.html#observeNodeValue">observeNodeValue</a></li><li><a href="global.html#observeOneForAllAction">observeOneForAllAction</a></li><li><a href="global.html#observeRemoveNode">observeRemoveNode</a></li><li><a href="global.html#observeSeekClientNodeState">observeSeekClientNodeState</a></li><li><a href="global.html#observeSeekState">observeSeekState</a></li><li><a href="global.html#parseClientNode">parseClientNode</a></li><li><a href="global.html#sortClientNodesBySequence">sortClientNodesBySequence</a></li><li><a href="global.html#unsubscribe">unsubscribe</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Mar 26 2017 14:11:12 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
